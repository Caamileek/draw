<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<title>Proporcje ‚Äì Mobile & Desktop</title>
<style>
body{margin:0;height:100vh;display:flex;background:#2b2b2b;color:#eee;font-family:Arial;}
#tools{width:250px;background:#3a3a3a;padding:10px;overflow:auto;}
#canvasWrap{flex:1;position:relative;background:#1e1e1e;overflow:hidden;}
canvas{width:100%;height:100%;cursor:crosshair;}
button,select,input,label{width:100%;margin-bottom:6px;padding:10px;background:#555;color:#eee;border:none;font-size:16px;border-radius:6px;}
li{padding:8px;cursor:pointer;display:flex;justify-content:space-between;align-items:center;font-size:16px;}
li.selected{background:#5a5aff;}
.tooltip{position:absolute;background:rgba(0,0,0,0.7);color:#fff;padding:4px 6px;font-size:14px;border-radius:4px;pointer-events:none;white-space:nowrap;}
.color-btn{width:30px;height:30px;border-radius:50%;margin-left:6px;cursor:pointer;border:1px solid #ccc;}
.delete-btn{cursor:pointer;margin-left:6px;color:#ff5555;font-size:18px;}
.hidden{display:none !important;}
.groupHeader{display:flex;justify-content:space-between;cursor:pointer;padding:6px;background:#444;margin-top:4px;border-radius:4px;}
#toggleTools,#toggleView{display:none;position:absolute;top:10px;z-index:20;padding:10px;background:#777;border:none;border-radius:6px;color:#fff;font-size:20px;}

/* Mobile responsive */
@media(max-width:768px){
  body{flex-direction:column;}
  #tools{
    width:100%;
    position:absolute;
    top:0;
    left:0;
    max-height:90vh;
    display:none;
    z-index:10;
    overflow-y:auto;
  }
  #tools.mobile.active{display:block;}
  #canvasWrap{margin-top:0;}
  button,select,input,label{font-size:18px;padding:12px;}
  li{font-size:18px;}
  #toggleTools,#toggleView{display:block;top:auto;bottom:10px;}
  #toggleTools{left:10px;}
  #toggleView{right:10px;}
}
</style>
</head>
<body>

<button id="toggleTools">‚ò∞ Narzƒôdzia</button>
<button id="toggleView">üëÅÔ∏è</button>

<div id="tools">
<h3>Narzƒôdzia</h3>
<input type="file" id="fileInput" accept="image/*">
<button id="zoomIn">‚ûï Zoom</button>
<button id="zoomOut">‚ûñ Zoom</button>

<label>D≈Çugo≈õƒá kopiowania</label>
<select id="lengthMode"><option value="1">Pe≈Çna</option><option value="0.5">Po≈Çowa</option></select>

<label>Przezroczysto≈õƒá</label>
<input type="range" id="opacity" min="0.2" max="1" step="0.05" value="1">

<label><input type="checkbox" id="learnMode"> üéì Tryb nauki</label>

<h4>Kopiuj</h4>
<button data-dir="left">‚¨ÖÔ∏è Lewo</button>
<button data-dir="right">‚û°Ô∏è Prawo</button>
<button data-dir="up">‚¨ÜÔ∏è G√≥ra</button>
<button data-dir="down">‚¨áÔ∏è D√≥≈Ç</button>

<h4>Dodaj do grupy</h4>
<select id="selectGroup">
  <option value="Poziome">Poziome</option>
  <option value="Pionowe">Pionowe</option>
  <option value="Dodatkowe">Dodatkowe</option>
</select>
<button id="addToGroup">Dodaj</button>

<div id="layers">
<h3>Warstwy</h3>
<div class="group" id="groupPoziome">
  <div class="groupHeader" onclick="toggleGroup('Poziome')">üìè Poziome ‚ñº</div>
  <ul id="listPoziome"></ul>
</div>
<div class="group" id="groupPionowe">
  <div class="groupHeader" onclick="toggleGroup('Pionowe')">üìè Pionowe ‚ñº</div>
  <ul id="listPionowe"></ul>
</div>
<div class="group" id="groupDodatkowe">
  <div class="groupHeader" onclick="toggleGroup('Dodatkowe')">üìÅ Dodatkowe ‚ñº</div>
  <ul id="listDodatkowe"></ul>
</div>
</div>
</div>

<div id="canvasWrap">
<canvas id="canvas"></canvas>
<div id="tooltip" class="tooltip" style="display:none;"></div>
</div>

<script>
const canvas=document.getElementById("canvas");
const ctx=canvas.getContext("2d");
const tooltip=document.getElementById("tooltip");
const layerList=document.getElementById("layerList");
const tools=document.getElementById("tools");
const toggleTools=document.getElementById("toggleTools");
const toggleView=document.getElementById("toggleView");

let img=new Image();
let scale=1,offX=0,offY=0,opacity=1;
let segments=[],selected=null,drawing=null,baseSegment=null;
const colors=["red","yellow"];
let firstPoint=null;

let draggingSegment=false;
let dragStart={x:0,y:0};

let groups={Poziome:[],Pionowe:[],Dodatkowe:[]};

/* ---------- DEVICE DETECTION ---------- */
const isMobileDevice = /Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
if(isMobileDevice){
  tools.classList.add("mobile");
  toggleTools.onclick=()=>tools.classList.toggle("active");
  toggleView.onclick=()=>{tools.classList.toggle("hidden"); draw();}
}

/* ---------- RESIZE ---------- */
function resize(){canvas.width=canvas.parentElement.clientWidth;canvas.height=canvas.parentElement.clientHeight; adjustPanels(); draw();}
window.onresize=resize; resize();

function adjustPanels(){
  const vh = window.innerHeight;
  const vw = window.innerWidth;
  if(vw<=768){ tools.style.maxHeight = (vh*0.9)+"px"; } 
  else{ tools.style.maxHeight = "100%"; }
}

/* ---------- IMAGE ---------- */
fileInput.onchange=e=>{const r=new FileReader(); r.onload=ev=>img.src=ev.target.result; r.readAsDataURL(e.target.files[0]);};
img.onload = ()=>{
  const canvasRatio = canvas.width / canvas.height;
  const imgRatio = img.width / img.height;
  if(imgRatio > canvasRatio){ scale = canvas.width / img.width; }
  else{ scale = canvas.height / img.height; }
  offX = (canvas.width - img.width*scale)/2;
  offY = (canvas.height - img.height*scale)/2;
  draw();
};

/* ---------- ZOOM ---------- */
zoomIn.onclick=()=>{scale*=1.2;draw();}
zoomOut.onclick=()=>{scale/=1.2;draw();}

/* ---------- DRAW ---------- */
function draw(){
  ctx.setTransform(1,0,0,1,0,0); ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.setTransform(scale,0,0,scale,offX,offY);
  if(img.src) ctx.drawImage(img,0,0);
  ctx.globalAlpha=opacity;
  segments.forEach(s=>{
    ctx.strokeStyle=s.color;
    ctx.lineWidth=(s===selected?4:2)/scale;
    ctx.beginPath(); ctx.moveTo(s.a.x,s.a.y); ctx.lineTo(s.b.x,s.b.y); ctx.stroke();
  });
  ctx.globalAlpha=1;
  if(drawing){
    ctx.setLineDash([8/scale,5/scale]);
    ctx.strokeStyle="rgba(255,255,255,0.9)";
    ctx.lineWidth=2/scale;
    ctx.beginPath(); ctx.moveTo(drawing.a.x,drawing.a.y);
    ctx.lineTo(drawing.b.x,drawing.b.y);
    ctx.stroke();
    ctx.beginPath();
    ctx.arc(drawing.a.x,drawing.a.y,7/scale,0,2*Math.PI);
    ctx.fillStyle="rgba(255,255,255,0.7)"; ctx.fill();
    ctx.setLineDash([]);
  }
}

/* ---------- POINTER / TOUCH ---------- */
let isPanning=false, panStartCanvas={x:0,y:0}, spacePressed=false, lastDist=null;

function getPointerPos(e){
  const r = canvas.getBoundingClientRect();
  let x=0,y=0;
  if(e.touches && e.touches.length>0){ x=(e.touches[0].clientX-r.left-offX)/scale; y=(e.touches[0].clientY-r.top-offY)/scale;}
  else { x=(e.clientX-r.left-offX)/scale; y=(e.clientY-r.top-offY)/scale;}
  return {x,y};
}

function startInteraction(e){
  e.preventDefault();
  const p = getPointerPos(e);

  // Dragging segment
  if(selected && isNearSegment(p,selected)){ draggingSegment=true; dragStart=p; return; }

  if(isMobileDevice && e.touches && e.touches.length===2){ lastDist = Math.hypot(e.touches[0].clientX-e.touches[1].clientX,e.touches[0].clientY-e.touches[1].clientY); return;}
  
  if(!firstPoint){ 
    firstPoint=p; 
    drawing={a:{...p},b:{...p}}; 
    draw(); 
    return;
  } else { 
    addSegment(firstPoint,p); 
    firstPoint=null; 
    drawing=null; 
    return;
  }

  if(!drawing && !draggingSegment){ drawing={a:{...p},b:{...p}}; }
  if(!isMobileDevice && spacePressed){ isPanning=true; panStartCanvas={x:e.clientX,y:e.clientY}; }
}

function moveInteraction(e){
  e.preventDefault();
  const p = getPointerPos(e);

  // Drag segment
  if(draggingSegment && selected){
    const dx=p.x-dragStart.x;
    const dy=p.y-dragStart.y;
    selected.a.x += dx;
    selected.a.y += dy;
    selected.b.x += dx;
    selected.b.y += dy;
    dragStart=p;
    draw(); updateGroups(); return;
  }

  if(isPanning){
    const clientX=(e.touches?e.touches[0].clientX:e.clientX);
    const clientY=(e.touches?e.touches[0].clientY:e.clientY);
    const dx = clientX - panStartCanvas.x;
    const dy = clientY - panStartCanvas.y;
    offX+=dx; offY+=dy; panStartCanvas={x:clientX,y:clientY};
    draw(); return;
  }

  if(isMobileDevice && e.touches && e.touches.length===2){
    const dist = Math.hypot(e.touches[0].clientX-e.touches[1].clientX,e.touches[0].clientY-e.touches[1].clientY);
    if(lastDist){ scale*=dist/lastDist; draw();}
    lastDist = dist; return;
  }

  if(drawing){ 
    const dx = p.x-drawing.a.x;
    const dy = p.y-drawing.a.y;
    if(Math.abs(dx)>Math.abs(dy) && Math.abs(dy)<10) p.y=drawing.a.y;
    if(Math.abs(dy)>Math.abs(dx) && Math.abs(dx)<10) p.x=drawing.a.x;
    drawing.b=p; draw();
  }
  showTooltip(p);
}

function endInteraction(e){
  draggingSegment=false;
  isPanning=false; lastDist=null;
  if(drawing && (!e.touches || e.touches.length===0)){
    addSegment(drawing.a,drawing.b);
    drawing=null; firstPoint=null;
  }
}

/* ---------- ADD SEGMENT ---------- */
function addSegment(a,b){
  const len = Math.hypot(b.x-a.x,b.y-a.y);
  let group = Math.abs(a.x-b.x)>Math.abs(a.y-b.y)?"Poziome":"Pionowe";
  const seg = {a:{...a}, b:{...b}, baseLength:len, realLength:len, color:colors[segments.length%2], group:group};
  segments.push(seg); selected=seg;
  if(learnMode.checked && !baseSegment) baseSegment=seg;
  updateGroups(); draw();
  if(learnMode.checked) showRatio(seg);
}

/* ---------- SPACE ---------- */
window.addEventListener('keydown',e=>{if(e.code==='Space'){spacePressed=true; e.preventDefault();}});
window.addEventListener('keyup',e=>{if(e.code==='Space'){spacePressed=false;}});

/* ---------- COPY ---------- */
document.querySelectorAll("[data-dir]").forEach(btn=>{
  btn.onclick=()=>{
    if(!selected)return;
    const factor=+lengthMode.value;
    const len=selected.baseLength*factor;
    let a={...selected.b},b={...a};
    if(btn.dataset.dir==="right")b.x+=len;
    if(btn.dataset.dir==="left")b.x-=len;
    if(btn.dataset.dir==="down")b.y+=len;
    if(btn.dataset.dir==="up")b.y-=len;
    const seg={a,b,baseLength:selected.baseLength,realLength:selected.baseLength*factor,color:colors[segments.length%2],group:selected.group};
    segments.push(seg); selected=seg; updateGroups(); draw();
    if(learnMode.checked && baseSegment && factor===1) showRatio(seg);
  };
});

/* ---------- EDUCATION OVERLAY ---------- */
function showRatio(seg){if(!learnMode.checked) return;
  const ratio=(seg.realLength/baseSegment.baseLength).toFixed(2);
  const badge=document.createElement("div"); badge.className="tooltip"; badge.textContent=`${ratio}√ó linii bazowej`;
  const mid={x:(seg.a.x+seg.b.x)/2*scale+offX, y:(seg.a.y+seg.b.y)/2*scale+offY};
  badge.style.left=mid.x+"px"; badge.style.top=mid.y+"px";
  canvas.parentElement.appendChild(badge); setTimeout(()=>badge.remove(),2000);
}

/* ---------- TOOLTIP ---------- */
function showTooltip(p){
  if(!learnMode.checked) {tooltip.style.display="none"; return;}
  let found=false;
  for(let s of segments){
    const d=distanceToSegment(p,s);
    if(d<5/scale){
      tooltip.style.display="block";
      tooltip.style.left=(p.x*scale+offX)+10+"px";
      tooltip.style.top=(p.y*scale+offY)+10+"px";
      if(baseSegment){
        const ratio=s.realLength/baseSegment.baseLength;
        tooltip.textContent = ratio.toFixed(2)==="1.00"?"Pe≈Çna linia bazowa":ratio.toFixed(2)==="0.50"?"Po≈Çowa linii bazowej":"Linia "+ratio.toFixed(2)+"√ó bazowej";
      } else tooltip.textContent="Brak linii bazowej";
      found=true; break;
    }
  }
  if(!found) tooltip.style.display="none";
}

/* ---------- LAYERS ---------- */
function updateGroups(){
  groups={Poziome:[],Pionowe:[],Dodatkowe:[]};
  segments.forEach(seg=>{groups[seg.group].push(seg);});

  for(let g in groups){
    const ul=document.getElementById("list"+g);
    ul.innerHTML="";
    groups[g].forEach((s,i)=>{
      const li=document.createElement("li");
      li.textContent="Odcinek "+(segments.indexOf(s)+1);
      li.className=s===selected?"selected":"";
      li.onclick=()=>{selected=s; draw(); updateGroups();};
      const colorBtn=document.createElement("div"); colorBtn.className="color-btn"; colorBtn.style.background=s.color;
      colorBtn.onclick=ev=>{ev.stopPropagation(); s.color=(s.color==="red"?"yellow":"red"); draw(); updateGroups();};
      li.appendChild(colorBtn);
      const delBtn=document.createElement("span"); delBtn.className="delete-btn"; delBtn.textContent="üóë";
      delBtn.onclick=ev=>{ev.stopPropagation(); segments.splice(segments.indexOf(s),1); if(selected===s) selected=null; updateGroups(); draw();};
      li.appendChild(delBtn);
      ul.appendChild(li);
    });
  }
}

function toggleGroup(groupName){
  const ul=document.getElementById("list"+groupName);
  ul.style.display = ul.style.display==="none"?"block":"none";
}

/* ---------- ADD TO GROUP BUTTON ---------- */
addToGroup.onclick=()=>{
  if(selected){
    selected.group = selectGroup.value;
    updateGroups();
    draw();
  }
}

/* ---------- INPUTS ---------- */
opacity.oninput=e=>{opacity=e.target.value;draw();}
learnMode.onchange=()=>{
  if(learnMode.checked && !baseSegment && segments.length>0) baseSegment=segments[0];
  updateGroups();
};

/* ---------- HELPERS ---------- */
function distanceToSegment(p,s){
  const x0=p.x, y0=p.y, x1=s.a.x, y1=s.a.y, x2=s.b.x, y2=s.b.y;
  const dx=x2-x1, dy=y2-y1;
  const t=Math.max(0,Math.min(1,((x0-x1)*dx+(y0-y1)*dy)/(dx*dx+dy*dy||1)));
  const x=x1+t*dx, y=y1+t*dy;
  return Math.hypot(x-x0,y-y0);
}

function isNearSegment(p,s){
  return distanceToSegment(p,s)<5/scale;
}

/* ---------- EVENTS ---------- */
canvas.addEventListener("mousedown",startInteraction);
canvas.addEventListener("mousemove",moveInteraction);
canvas.addEventListener("mouseup",endInteraction);
canvas.addEventListener("mouseleave",endInteraction);
canvas.addEventListener("touchstart",startInteraction,{passive:false});
canvas.addEventListener("touchmove",moveInteraction,{passive:false});
canvas.addEventListener("touchend",endInteraction);
</script>
</body>
</html>
